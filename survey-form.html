<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”³è«‹è€…æƒ…å ±ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ - éšœå®³å¹´é‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- APIé€£æºã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="js/application-api.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    },
                    colors: {
                        'notion-gray': {
                            50: '#fbfbfb',
                            100: '#f7f6f3',
                            200: '#ebeae6',
                            300: '#d1cfc8',
                            400: '#9b9a97',
                            500: '#787774',
                            600: '#5e5d5a',
                            700: '#37352f',
                            800: '#25241f',
                            900: '#1f1e1a'
                        },
                        'primary': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-notion-gray-50 font-sans antialiased">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center space-x-4">
                <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                        <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-semibold text-gray-900">ç”³è«‹è€…æƒ…å ±ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>
                    <p class="text-sm text-gray-500">éšœå®³å¹´é‡‘ç”³è«‹ã®è©³ç´°æƒ…å ±ã‚’ã”è¨˜å…¥ãã ã•ã„</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        <!-- é€²æ—è¡¨ç¤º -->
        <div class="mb-8">
            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                <span>é€²æ—çŠ¶æ³</span>
                <span id="progress-text">1 / 2</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
            </div>
        </div>

        <form id="survey-form" class="space-y-8">
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ç”³è«‹è€…åŸºæœ¬æƒ…å ± -->
            <div id="section-1" class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">ç”³è«‹è€…åŸºæœ¬æƒ…å ±</h2>
                    <p class="text-gray-600">åŸºæœ¬çš„ãªå€‹äººæƒ…å ±ã‚’ã”è¨˜å…¥ãã ã•ã„</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ°å <span class="text-red-500">*</span></label>
                        <input type="text" id="fullName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                               placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ•ãƒªã‚¬ãƒŠ <span class="text-red-500">*</span></label>
                        <input type="text" id="furigana" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                               placeholder="ä¾‹: ã‚¿ãƒŠã‚«ã‚¿ãƒ­ã‚¦">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”Ÿå¹´æœˆæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="birthDate" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ€§åˆ¥ <span class="text-red-500">*</span></label>
                        <select id="gender" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŸºç¤å¹´é‡‘ç•ªå· <span class="text-red-500">*</span></label>
                        <input type="text" id="pensionNumber" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                               placeholder="ä¾‹: 1234-567890">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç¾ä½æ‰€ <span class="text-red-500">*</span></label>
                        
                        <!-- éƒµä¾¿ç•ªå·ã¨æ¤œç´¢ -->
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-600 mb-1">éƒµä¾¿ç•ªå·</label>
                                <input type="text" id="postalCode" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                                       placeholder="ä¾‹: 160-0022" maxlength="8">
                            </div>
                            <button type="button" onclick="searchAddress()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm mt-5">
                                ä½æ‰€æ¤œç´¢
                            </button>
                        </div>
                        
                        <!-- è©³ç´°ä½æ‰€ -->
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">è©³ç´°ä½æ‰€</label>
                            <textarea id="address" required rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none resize-none"
                                      placeholder="ä¾‹: æ±äº¬éƒ½æ–°å®¿åŒºæ–°å®¿1-2-3 ãƒãƒ³ã‚·ãƒ§ãƒ³å101å·å®¤"></textarea>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©±ç•ªå· <span class="text-red-500">*</span></label>
                        <input type="tel" id="phoneNumber" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                               placeholder="ä¾‹: 090-1234-5678">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                               placeholder="ä¾‹: example@email.com">
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextSection(1)" 
                            class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all duration-200">
                        æ¬¡ã¸ â†’
                    </button>
                </div>
            </div>

            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å‚·ç—…æƒ…å ± -->
            <div id="section-2" class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">å‚·ç—…æƒ…å ±</h2>
                    <p class="text-gray-600">å‚·ç—…åã¨é–¢é€£æƒ…å ±ã‚’ã”è¨˜å…¥ãã ã•ã„</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»ãªå‚·ç—…å <span class="text-red-500">*</span></label>
                        <input type="text" id="mainDisease" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                               placeholder="ä¾‹: ã†ã¤ç—…ã€çµ±åˆå¤±èª¿ç—‡ã€ç³–å°¿ç—…ãªã©">
                    </div>



                    <!-- é€šé™¢å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">é€šé™¢å±¥æ­´</h3>
                        <p class="text-gray-600 mb-6">ã“ã‚Œã¾ã§ã®é€šé™¢å±¥æ­´ã‚’ã”è¨˜å…¥ãã ã•ã„</p>

                        <div id="hospital-entries" class="space-y-6">
                            <!-- åˆæœŸã®ç—…é™¢ã‚¨ãƒ³ãƒˆãƒª -->
                            <div class="hospital-entry border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-medium text-gray-900">åŒ»ç™‚æ©Ÿé–¢ 1</h3>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">åŒ»ç™‚æ©Ÿé–¢å <span class="text-red-500">*</span></label>
                                        <input type="text" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                                               placeholder="ä¾‹: æ–°å®¿ç—…é™¢">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">é€šé™¢é–‹å§‹æ—¥ <span class="text-red-500">*</span></label>
                                        <input type="text" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none"
                                               placeholder="ä¾‹: 2023å¹´5æœˆé ƒã€2023/05/10">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" onclick="addHospitalEntry()" 
                                class="mt-4 px-4 py-2 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-primary-400 hover:text-primary-600 transition-all duration-200 w-full">
                            + åŒ»ç™‚æ©Ÿé–¢ã‚’è¿½åŠ 
                        </button>
                    </div>

                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevSection(2)" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200">
                        â† æˆ»ã‚‹
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200">
                        å›ç­”ã‚’é€ä¿¡
                    </button>
                </div>
            </div>
        </form>
    </main>

    <!-- é€ä¿¡å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">é€ä¿¡å®Œäº†</h3>
            <p class="text-gray-600 mb-6">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>å†…å®¹ã‚’ç¢ºèªå¾Œã€æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚</p>
            <button onclick="closeSuccessModal()" 
                    class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all duration-200">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <script>
        let currentSection = 1;
        let hospitalCount = 1;

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        function nextSection(section) {
            if (!validateSection(section)) return;

            document.getElementById(`section-${section}`).classList.add('hidden');
            currentSection = section + 1;
            document.getElementById(`section-${currentSection}`).classList.remove('hidden');
            updateProgress();
        }

        function prevSection(section) {
            document.getElementById(`section-${section}`).classList.add('hidden');
            currentSection = section - 1;
            document.getElementById(`section-${currentSection}`).classList.remove('hidden');
            updateProgress();
        }

        // é€²æ—æ›´æ–°
        function updateProgress() {
            const progress = (currentSection / 2) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${currentSection} / 2`;
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateSection(section) {
            const sectionEl = document.getElementById(`section-${section}`);
            const requiredInputs = sectionEl.querySelectorAll('[required]');
            
            for (let input of requiredInputs) {
                if (!input.value.trim()) {
                    input.focus();
                    input.classList.add('border-red-500');
                    setTimeout(() => input.classList.remove('border-red-500'), 3000);
                    return false;
                }
            }
            return true;
        }

        // åŒ»ç™‚æ©Ÿé–¢ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
        function addHospitalEntry() {
            hospitalCount++;
            const template = document.querySelector('.hospital-entry').cloneNode(true);
            template.querySelector('h3').textContent = `åŒ»ç™‚æ©Ÿé–¢ ${hospitalCount}`;
            
            // è¿½åŠ å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const header = template.querySelector('.flex.items-center.justify-between');
            header.innerHTML += `
                <button type="button" onclick="removeHospitalEntry(this)" 
                        class="text-red-600 hover:text-red-800 text-sm">
                    å‰Šé™¤
                </button>
            `;
            
            // å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢
            template.querySelectorAll('input, textarea').forEach(input => {
                input.value = '';
            });
            
            document.getElementById('hospital-entries').appendChild(template);
        }

        function removeHospitalEntry(button) {
            button.closest('.hospital-entry').remove();
        }


        // é€ä¿¡å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
        let isSubmitting = false;

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // äºŒé‡é€ä¿¡é˜²æ­¢
            if (isSubmitting) {
                console.log('âš ï¸ é€ä¿¡å‡¦ç†ä¸­ã§ã™ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
                showNotification('é€ä¿¡å‡¦ç†ä¸­ã§ã™ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
                return;
            }
            
            if (!validateSection(2)) return;
            
            isSubmitting = true;
            
            // é€ä¿¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const submitBtn = document.querySelector('[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'é€ä¿¡ä¸­...';
            submitBtn.disabled = true;
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                await saveSurveyData();
                
                // å›ç­”å®Œäº†ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
                recordSurveyCompletion('ç”³è«‹è€…åŸºæœ¬æƒ…å ±');
                
                // æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                setTimeout(() => {
                    document.getElementById('success-modal').classList.remove('hidden');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    isSubmitting = false;
                }, 1000);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMsg = 'ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (error.message && error.message.includes('429')) {
                    errorMsg = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                }
                
                alert(errorMsg);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                isSubmitting = false;
            }
        });

        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”å®Œäº†ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        function recordSurveyCompletion(surveyType) {
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const formData = collectFormData();
            
            // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆproject-unified.htmlï¼‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            if (window.opener && window.opener.addSurveyLog) {
                window.opener.addSurveyLog('å›ç­”å®Œäº†', surveyType);
                
                // å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚‚é€ä¿¡
                if (window.opener.recordSurveyResponse) {
                    window.opener.recordSurveyResponse('basic', formData);
                }
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹é–¢æ•°
        function collectFormData() {
            const formData = {};
            
            // åŸºæœ¬æƒ…å ±
            formData.fullName = document.getElementById('fullName')?.value || '';
            formData.furigana = document.getElementById('furigana')?.value || '';
            formData.birthDate = document.getElementById('birthDate')?.value || '';
            formData.gender = document.getElementById('gender')?.value || '';
            formData.pensionNumber = document.getElementById('pensionNumber')?.value || '';
            formData.postalCode = document.getElementById('postalCode')?.value || '';
            formData.address = document.getElementById('address')?.value || '';
            formData.phoneNumber = document.getElementById('phoneNumber')?.value || '';
            formData.email = document.getElementById('email')?.value || '';
            
            // å‚·ç—…æƒ…å ±
            formData.mainDisease = document.getElementById('mainDisease')?.value || '';
            formData.disabilityDescription = formData.mainDisease; // Map to expected field
            
            // é€šé™¢å±¥æ­´
            formData.hospitals = [];
            document.querySelectorAll('.hospital-entry').forEach(entry => {
                const inputs = entry.querySelectorAll('input');
                if (inputs.length >= 2) {
                    formData.hospitals.push({
                        name: inputs[0].value,
                        startDate: inputs[1].value
                    });
                }
            });
            
            return formData;
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        async function saveSurveyData() {
            try {
                // é–‹ç™ºç’°å¢ƒã§èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    DevAuth.skipAuth();
                }
                
                const formData = collectFormData();
                const urlParams = new URLSearchParams(window.location.search);
                let applicationId = urlParams.get('id');
                
                // applicationIdãŒç”³è«‹ç•ªå·å½¢å¼ï¼ˆAPP-XXXX-XXXï¼‰ã®å ´åˆã¯ã€æ•°å€¤IDã«å¤‰æ›ã‚’è©¦ã¿ã‚‹
                if (applicationId && isNaN(applicationId)) {
                    console.log('ğŸ“‹ ç”³è«‹ç•ªå·ã‹ã‚‰ç”³è«‹ã‚’æ¤œç´¢:', applicationId);
                    try {
                        // ç”³è«‹ç•ªå·ã§æ¤œç´¢ï¼ˆsearchãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
                        const result = await ApplicationAPI.getApplications({ search: applicationId });
                        if (result.applications && result.applications.length > 0) {
                            applicationId = result.applications[0].id;
                            console.log('âœ… ç”³è«‹IDã‚’å–å¾—:', applicationId);
                        } else {
                            throw new Error('ç”³è«‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                    } catch (searchError) {
                        console.error('ç”³è«‹ç•ªå·ã§ã®æ¤œç´¢ã«å¤±æ•—:', searchError);
                        applicationId = null;
                    }
                }
                
                // ç”³è«‹IDãŒãªã„å ´åˆã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç”³è«‹è€…æƒ…å ±ã‚’å–å¾—ã—ã¦æ–°è¦ä½œæˆ
                if (!applicationId) {
                    const applicantName = urlParams.get('name') || formData.fullName || 'æœªå…¥åŠ›';
                    console.log('ğŸ“ æ–°è¦ç”³è«‹ã‚’ä½œæˆã—ã¾ã™:', applicantName);
                    
                    const newApplication = await ApplicationAPI.createApplication({
                        applicantName: applicantName,
                        applicantNameKana: formData.furigana || 'ãƒŸãƒ‹ãƒ¥ã‚¦ãƒªãƒ§ã‚¯',
                        birthDate: formData.birthDate || '1990-01-01',
                        gender: formData.gender || 'male',
                        pensionNumber: formData.pensionNumber || '',
                        phoneNumber: formData.phoneNumber || '',
                        email: formData.email || null,
                        address: formData.address || '',
                        postalCode: formData.postalCode || '',
                        disabilityType: 'mental', // Required field
                        disabilityDescription: formData.disabilityDescription || formData.mainDisease || '',
                        applicationType: 'new'
                    });
                    applicationId = newApplication.application.id;
                    console.log('âœ… æ–°è¦ç”³è«‹ã‚’ä½œæˆã—ã¾ã—ãŸ:', applicationId);
                } else {
                    // æ—¢å­˜ã®ç”³è«‹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    try {
                        await ApplicationAPI.getApplication(applicationId);
                    } catch (error) {
                        if (error.message.includes('not found')) {
                        // ç”³è«‹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€æ–°è¦ä½œæˆ
                        const newApplication = await ApplicationAPI.createApplication({
                            applicantName: formData.fullName || 'æœªå…¥åŠ›',
                            applicantNameKana: formData.furigana || 'ãƒŸãƒ‹ãƒ¥ã‚¦ãƒªãƒ§ã‚¯',
                            birthDate: formData.birthDate || '1990-01-01',
                            gender: formData.gender || 'male',
                            pensionNumber: formData.pensionNumber || '',
                            phoneNumber: formData.phoneNumber || '',
                            email: formData.email || null,
                            address: formData.address || '',
                            postalCode: formData.postalCode || '',
                            disabilityType: 'mental', // Required field
                            disabilityDescription: formData.disabilityDescription || formData.mainDisease || '',
                            applicationType: 'new'
                        });
                        applicationId = newApplication.application.id;
                        console.log('æ–°è¦ç”³è«‹ã‚’ä½œæˆã—ã¾ã—ãŸ:', applicationId);
                    } else {
                        throw error;
                    }
                }
                
                // Survey APIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const result = await SurveyAPI.saveSurvey(applicationId, 'basic', formData, 'completed');
                
                if (result) {
                    console.log('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', result);
                    return true;
                }
            } catch (error) {
                console.error('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: LocalStorageã«ä¿å­˜
                const formData = collectFormData();
                localStorage.setItem('survey_basic_data', JSON.stringify(formData));
                console.log('LocalStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜ã—ã¾ã—ãŸ');
                return true;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadSurveyData() {
            try {
                // é–‹ç™ºç’°å¢ƒã§èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    DevAuth.skipAuth();
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const applicationId = urlParams.get('id') || 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆID
                
                // Survey APIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const result = await SurveyAPI.getSurvey(applicationId, 'basic');
                
                if (result && result.data) {
                    populateFormFields(result.data);
                    console.log('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', result.data);
                    return result.data;
                } else {
                    console.log('ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return null;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
                try {
                    const localData = localStorage.getItem('survey_basic_data');
                    if (localData) {
                        const data = JSON.parse(localData);
                        populateFormFields(data);
                        console.log('LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', data);
                        return data;
                    }
                } catch (localError) {
                    console.error('LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', localError);
                }
                
                return null;
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        function populateFormFields(data) {
            if (!data) return;
            
            // åŸºæœ¬æƒ…å ± - survey dataã‹ã‚‰
            if (data.fullName) document.getElementById('fullName').value = data.fullName;
            if (data.furigana) document.getElementById('furigana').value = data.furigana;
            if (data.birthDate) document.getElementById('birthDate').value = data.birthDate;
            if (data.gender) document.getElementById('gender').value = data.gender;
            if (data.pensionNumber) document.getElementById('pensionNumber').value = data.pensionNumber;
            if (data.postalCode) document.getElementById('postalCode').value = data.postalCode;
            if (data.address) document.getElementById('address').value = data.address;
            if (data.phoneNumber) document.getElementById('phoneNumber').value = data.phoneNumber;
            if (data.email) document.getElementById('email').value = data.email;
            
            // Application dataã‹ã‚‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            if (data.applicantName && !data.fullName) document.getElementById('fullName').value = data.applicantName;
            if (data.applicantNameKana && !data.furigana) document.getElementById('furigana').value = data.applicantNameKana;
            
            // å‚·ç—…æƒ…å ±
            if (data.mainDisease) document.getElementById('mainDisease').value = data.mainDisease;
            if (data.disabilityDescription && !data.mainDisease) document.getElementById('mainDisease').value = data.disabilityDescription;
            
            // é€šé™¢å±¥æ­´
            if (data.hospitals && data.hospitals.length > 0) {
                // æ—¢å­˜ã®ç—…é™¢ã‚¨ãƒ³ãƒˆãƒªã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®1ã¤ã¯æ®‹ã™ï¼‰
                const hospitalEntries = document.getElementById('hospital-entries');
                const firstEntry = hospitalEntries.querySelector('.hospital-entry');
                hospitalEntries.innerHTML = '';
                hospitalEntries.appendChild(firstEntry);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                data.hospitals.forEach((hospital, index) => {
                    if (index === 0) {
                        // æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒªã«è¨­å®š
                        const inputs = firstEntry.querySelectorAll('input');
                        if (inputs.length >= 2) {
                            inputs[0].value = hospital.name || '';
                            inputs[1].value = hospital.startDate || '';
                        }
                    } else {
                        // è¿½åŠ ã®ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
                        addHospitalEntry();
                        const allEntries = hospitalEntries.querySelectorAll('.hospital-entry');
                        const lastEntry = allEntries[allEntries.length - 1];
                        const inputs = lastEntry.querySelectorAll('input');
                        if (inputs.length >= 2) {
                            inputs[0].value = hospital.name || '';
                            inputs[1].value = hospital.startDate || '';
                        }
                    }
                });
            }
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ç®¡ç†ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¾ãŸã¯ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹
        }

        // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
        function showNotification(message, type = 'info') {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification-toast fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' :
                'bg-blue-500'
            }`;
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
            const icon = type === 'success' ? 'âœ…' : 
                         type === 'error' ? 'âŒ' : 
                         type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2 text-xl">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å°‘ã—é•·ãè¡¨ç¤º
            const duration = type === 'warning' ? 5000 : 3000;
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // ä½æ‰€æ¤œç´¢æ©Ÿèƒ½ï¼ˆéƒµä¾¿ç•ªå·APIé€£æºã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
        function searchAddress() {
            const postalCode = document.getElementById('postalCode').value;
            if (!postalCode) {
                alert('éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯éƒµä¾¿ç•ªå·APIã‚’ä½¿ç”¨
            // ä¾‹: zipcloud API, éƒµä¾¿ç•ªå·æ¤œç´¢API ãªã©
            alert('ä½æ‰€æ¤œç´¢æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚\nå®Ÿè£…æ™‚ã¯éƒµä¾¿ç•ªå·APIã¨é€£æºã—ã¾ã™ã€‚');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const id = urlParams.get('id');
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åå‰ã‚’è¨­å®š
            if (name) {
                document.getElementById('fullName').value = name;
            }
            
            // é–‹ç™ºç’°å¢ƒã§èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (typeof DevAuth !== 'undefined') {
                DevAuth.skipAuth();
            }
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            try {
                const surveyData = await loadSurveyData();
                
                // Survey dataãŒãªã„å ´åˆã€application dataã‚’è©¦è¡Œ
                if (!surveyData && id) {
                    try {
                        const applicationResult = await ApplicationAPI.getApplication(id);
                        if (applicationResult && applicationResult.application) {
                            populateFormFields(applicationResult.application);
                            console.log('Application dataã‹ã‚‰åŸºæœ¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                        }
                    } catch (appError) {
                        console.log('Application dataèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', appError);
                    }
                }
            } catch (error) {
                console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆæ–°è¦ä½œæˆã®å ´åˆã¯æ­£å¸¸ï¼‰:', error);
            }
        });
    </script>
</body>
</html>