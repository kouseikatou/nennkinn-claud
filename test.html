<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 統合デバッグツール - 障害年金管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            margin: 4px 0;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            word-break: break-all;
        }
        .log-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .log-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .log-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .log-debug { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        
        .json-viewer {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-checking { background-color: #ffc107; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .tab-button {
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            border-bottom: 2px solid #1d4ed8;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🔧 統合デバッグツール</h1>
            <p class="text-gray-600">API接続、データベース、そしてproject-unified.htmlの問題を包括的に診断します</p>
        </div>

        <!-- 接続状態ダッシュボード -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span id="connectionStatus" class="status-indicator status-checking"></span>
                システム状態
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">APIサーバー</h3>
                    <p id="apiStatus" class="text-sm text-gray-600">確認中...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">データベース</h3>
                    <p id="dbStatus" class="text-sm text-gray-600">確認中...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">認証状態</h3>
                    <p id="authStatus" class="text-sm text-gray-600">確認中...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">project-unified</h3>
                    <p id="unifiedStatus" class="text-sm text-gray-600">確認中...</p>
                </div>
            </div>
        </div>

        <!-- タブナビゲーション -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button onclick="switchTab('api-test')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 active">
                        🚀 API テスト
                    </button>
                    <button onclick="switchTab('project-debug')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        🐛 project-unified 診断
                    </button>
                    <button onclick="switchTab('console-monitor')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        📊 コンソール監視
                    </button>
                    <button onclick="switchTab('network-monitor')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        🌐 ネットワーク監視
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- タブコンテンツ: API テスト -->
        <div id="api-test" class="tab-content active">
            <!-- API設定 -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🔧 API設定</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ベースURL</label>
                        <input type="text" id="baseUrl" value="https://nennkinn-claud.vercel.app/api" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">認証トークン</label>
                        <input type="text" id="authToken" placeholder="Bearer token（オプション）"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- クイックテスト -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">⚡ クイックテスト</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onclick="testHealthCheck()" 
                            class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        ヘルスチェック
                    </button>
                    <button onclick="testLogin()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        ログインテスト
                    </button>
                    <button onclick="testApplications()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        申請データ取得
                    </button>
                    <button onclick="testDatabaseConnection()" 
                            class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        DB接続テスト
                    </button>
                </div>
            </div>

            <!-- カスタムリクエスト -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🛠️ カスタムリクエスト</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">メソッド</label>
                        <select id="method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">エンドポイント</label>
                        <input type="text" id="endpoint" placeholder="/applications" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">リクエストボディ（JSON）</label>
                    <textarea id="requestBody" rows="4" placeholder='{"key": "value"}'
                              class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <button onclick="sendCustomRequest()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded transition-colors">
                    リクエスト送信
                </button>
            </div>
        </div>

        <!-- タブコンテンツ: project-unified 診断 -->
        <div id="project-debug" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🐛 project-unified.html 診断</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <button onclick="testUnifiedPageLoad()" 
                            class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        ページ読み込みテスト
                    </button>
                    <button onclick="testApplicationApiLoad()" 
                            class="bg-teal-500 hover:bg-teal-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        application-api.js チェック
                    </button>
                    <button onclick="simulateEditMode()" 
                            class="bg-pink-500 hover:bg-pink-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        編集モード(?edit=1) 模擬
                    </button>
                    <button onclick="testLocalStorageData()" 
                            class="bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        ローカルストレージ確認
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">テスト用申請ID</label>
                    <input type="text" id="testApplicationId" value="1" placeholder="1" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- タブコンテンツ: コンソール監視 -->
        <div id="console-monitor" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">📊 リアルタイムコンソール監視</h2>
                <div class="mb-4">
                    <button onclick="toggleConsoleCapture()" id="consoleToggle"
                            class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition-colors mr-2">
                        コンソール監視開始
                    </button>
                    <button onclick="clearConsoleLog()" 
                            class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        コンソールクリア
                    </button>
                </div>
                <div id="consoleOutput" class="bg-gray-900 text-green-400 p-4 rounded-md font-mono text-sm max-h-96 overflow-y-auto">
                    コンソール監視待機中...
                </div>
            </div>
        </div>

        <!-- タブコンテンツ: ネットワーク監視 -->
        <div id="network-monitor" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🌐 ネットワークリクエスト監視</h2>
                <div class="mb-4">
                    <button onclick="toggleNetworkCapture()" id="networkToggle"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors mr-2">
                        ネットワーク監視開始
                    </button>
                    <button onclick="clearNetworkLog()" 
                            class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        ログクリア
                    </button>
                </div>
                <div id="networkOutput" class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-sm">ネットワーク監視待機中...</div>
                </div>
            </div>
        </div>

        <!-- ログ表示 -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">📋 統合ログ</h2>
                <div class="space-x-2">
                    <button onclick="exportLogs()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                        エクスポート
                    </button>
                    <button onclick="clearLogs()" 
                            class="bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                        クリア
                    </button>
                </div>
            </div>
            <div id="logContainer" class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto">
                <div class="log-entry log-info">統合デバッグツールが準備完了しました</div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let logs = [];
        let consoleCapturing = false;
        let networkCapturing = false;
        let originalConsole = {};
        let originalFetch = null;

        // ログ出力関数
        function log(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = {
                timestamp,
                message,
                type,
                data
            };
            logs.push(logEntry);
            
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            let content = `[${timestamp}] ${message}`;
            entry.textContent = content;
            
            if (data) {
                const dataView = document.createElement('div');
                dataView.className = 'json-viewer';
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                dataView.appendChild(pre);
                entry.appendChild(dataView);
            }
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry log-info">ログをクリアしました</div>';
        }

        function exportLogs() {
            const logText = logs.map(log => 
                `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}${log.data ? '\n' + JSON.stringify(log.data, null, 2) : ''}`
            ).join('\n\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-${new Date().toISOString()}.log`;
            a.click();
        }

        // 接続状態を更新
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = `status-indicator status-${status}`;
        }

        // タブ切り替え
        function switchTab(tabName) {
            // 全てのタブコンテンツを非表示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 全てのタブボタンを非アクティブ
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 選択されたタブを表示
            document.getElementById(tabName).classList.add('active');
            
            // 対応するボタンをアクティブ
            event.target.classList.add('active');
        }

        // API呼び出し関数
        async function makeRequest(method, endpoint, body = null) {
            const baseUrl = document.getElementById('baseUrl').value;
            const authToken = document.getElementById('authToken').value;
            
            const url = `${baseUrl}${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                options.headers['Authorization'] = authToken.startsWith('Bearer ') ? authToken : `Bearer ${authToken}`;
            }

            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }

            log(`🚀 ${method} ${url}`, 'info');
            
            try {
                const response = await fetch(url, options);
                const responseText = await response.text();
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch {
                    responseData = responseText;
                }

                if (response.ok) {
                    log(`✅ ${response.status} - 成功`, 'success', responseData);
                    updateConnectionStatus('connected');
                } else {
                    log(`❌ ${response.status} ${response.statusText} - 失敗`, 'error', responseData);
                    updateConnectionStatus('disconnected');
                }

                return { response, data: responseData };
            } catch (error) {
                log(`💥 ネットワークエラー: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
                return { error };
            }
        }

        // 基本テスト関数
        async function testHealthCheck() {
            log('🏥 ヘルスチェックを実行中...', 'info');
            updateConnectionStatus('checking');
            
            const result = await makeRequest('GET', '/health');
            if (result.data) {
                document.getElementById('apiStatus').textContent = '正常動作中';
            } else {
                document.getElementById('apiStatus').textContent = '接続失敗';
            }
        }

        async function testLogin() {
            log('🔐 ログインテストを実行中...', 'info');
            const credentials = {
                email: 'admin@disability-pension.jp',
                password: 'admin123'
            };
            const result = await makeRequest('POST', '/auth/login', credentials);
            
            if (result.data && result.data.token) {
                document.getElementById('authToken').value = result.data.token;
                document.getElementById('authStatus').textContent = 'ログイン可能';
                log('🎉 トークンを自動設定しました', 'success');
            } else {
                document.getElementById('authStatus').textContent = '認証エラー';
            }
        }

        async function testApplications() {
            log('📋 申請データ取得テストを実行中...', 'info');
            const result = await makeRequest('GET', '/applications?limit=3');
            
            if (result.data && result.data.applications) {
                document.getElementById('dbStatus').textContent = `接続済み (${result.data.applications.length}件)`;
            } else {
                document.getElementById('dbStatus').textContent = '接続エラー';
            }
        }

        async function testDatabaseConnection() {
            log('🗄️ データベース接続をテスト中...', 'info');
            
            try {
                // ApplicationAPIが利用可能か確認
                if (typeof ApplicationAPI !== 'undefined') {
                    const result = await ApplicationAPI.getApplications({ limit: 1 });
                    log('✅ データベース接続成功', 'success', result);
                    document.getElementById('dbStatus').textContent = '接続済み';
                } else {
                    // API経由でテスト
                    await testApplications();
                }
            } catch (error) {
                log(`❌ データベース接続エラー: ${error.message}`, 'error', error);
                document.getElementById('dbStatus').textContent = '接続エラー';
            }
        }

        async function sendCustomRequest() {
            const method = document.getElementById('method').value;
            const endpoint = document.getElementById('endpoint').value;
            const bodyText = document.getElementById('requestBody').value;

            let body = null;
            if (bodyText.trim()) {
                try {
                    body = JSON.parse(bodyText);
                } catch (error) {
                    log(`❌ JSONパースエラー: ${error.message}`, 'error');
                    return;
                }
            }

            await makeRequest(method, endpoint, body);
        }

        // project-unified 診断関数
        async function testUnifiedPageLoad() {
            log('🔍 project-unified.html ページ読み込みテスト開始', 'info');
            
            try {
                const response = await fetch('/project-unified.html');
                if (response.ok) {
                    const html = await response.text();
                    log('✅ project-unified.html 読み込み成功', 'success');
                    
                    // JavaScript依存関係をチェック
                    if (html.includes('js/application-api.js')) {
                        log('📍 application-api.js の依存関係を確認', 'info');
                        await testApplicationApiLoad();
                    }
                    
                    document.getElementById('unifiedStatus').textContent = 'ページ読み込み成功';
                } else {
                    log(`❌ project-unified.html 読み込み失敗: ${response.status}`, 'error');
                    document.getElementById('unifiedStatus').textContent = '読み込み失敗';
                }
            } catch (error) {
                log(`💥 ページ読み込みエラー: ${error.message}`, 'error');
                document.getElementById('unifiedStatus').textContent = '接続エラー';
            }
        }

        async function testApplicationApiLoad() {
            log('🔧 application-api.js ロードテスト開始', 'info');
            
            try {
                const response = await fetch('/js/application-api.js');
                if (response.ok) {
                    const jsCode = await response.text();
                    log('✅ application-api.js ファイル存在確認', 'success');
                    
                    // APIベースURL設定をチェック
                    if (jsCode.includes('getAPIBaseURL')) {
                        log('📍 API設定関数を確認', 'debug');
                    }
                    
                    // ApplicationAPIオブジェクトの存在確認
                    if (typeof ApplicationAPI !== 'undefined') {
                        log('✅ ApplicationAPI オブジェクトが利用可能', 'success');
                    } else {
                        log('⚠️ ApplicationAPI オブジェクトが未読み込み', 'warning');
                    }
                } else {
                    log(`❌ application-api.js 読み込み失敗: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`💥 application-api.js 読み込みエラー: ${error.message}`, 'error');
            }
        }

        async function simulateEditMode() {
            log('🎭 編集モード(?edit=1) 模擬テスト開始', 'info');
            const applicationId = document.getElementById('testApplicationId').value || '1';
            
            try {
                // 申請データの取得テスト
                log(`📊 申請データ読み込みテスト (ID: ${applicationId})`, 'info');
                const result = await makeRequest('GET', `/applications/${applicationId}`);
                
                if (result.data) {
                    log('✅ 申請データ取得成功', 'success', result.data);
                    document.getElementById('unifiedStatus').textContent = '編集モード対応';
                    
                    // ローカルストレージへの保存をシミュレート
                    localStorage.setItem(`application_${applicationId}`, JSON.stringify(result.data));
                    log('💾 ローカルストレージに保存しました', 'info');
                } else {
                    log('❌ 申請データが見つかりません', 'error');
                    document.getElementById('unifiedStatus').textContent = 'データ不明';
                }
            } catch (error) {
                log(`💥 編集モード模擬エラー: ${error.message}`, 'error');
                document.getElementById('unifiedStatus').textContent = 'エラー';
            }
        }

        async function testLocalStorageData() {
            log('🗄️ ローカルストレージデータ確認', 'info');
            
            const applicationId = document.getElementById('testApplicationId').value || '1';
            const storageKey = `application_${applicationId}`;
            const storedData = localStorage.getItem(storageKey);
            
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    log(`✅ ローカルストレージデータ発見 (${storageKey})`, 'success', parsedData);
                } catch (error) {
                    log(`❌ ローカルストレージデータのパースエラー: ${error.message}`, 'error');
                }
            } else {
                log(`⚠️ ローカルストレージにデータが存在しません (${storageKey})`, 'warning');
                
                // 全てのキーを調査
                const allKeys = Object.keys(localStorage);
                if (allKeys.length > 0) {
                    log(`📋 存在するローカルストレージキー:`, 'info', allKeys);
                } else {
                    log('📋 ローカルストレージは空です', 'info');
                }
            }
        }

        // コンソール監視機能
        function toggleConsoleCapture() {
            const button = document.getElementById('consoleToggle');
            const output = document.getElementById('consoleOutput');
            
            if (!consoleCapturing) {
                // コンソール監視開始
                originalConsole.log = console.log;
                originalConsole.error = console.error;
                originalConsole.warn = console.warn;
                originalConsole.info = console.info;
                
                console.log = function(...args) {
                    originalConsole.log.apply(console, args);
                    appendConsoleLog('LOG', args.join(' '), '#4ade80');
                };
                
                console.error = function(...args) {
                    originalConsole.error.apply(console, args);
                    appendConsoleLog('ERROR', args.join(' '), '#ef4444');
                };
                
                console.warn = function(...args) {
                    originalConsole.warn.apply(console, args);
                    appendConsoleLog('WARN', args.join(' '), '#f59e0b');
                };
                
                console.info = function(...args) {
                    originalConsole.info.apply(console, args);
                    appendConsoleLog('INFO', args.join(' '), '#3b82f6');
                };
                
                consoleCapturing = true;
                button.textContent = 'コンソール監視停止';
                button.className = button.className.replace('bg-green-500', 'bg-red-500').replace('hover:bg-green-600', 'hover:bg-red-600');
                output.innerHTML = '<div style="color: #4ade80;">コンソール監視開始...</div>';
                
                log('📊 コンソール監視を開始しました', 'info');
            } else {
                // コンソール監視停止
                console.log = originalConsole.log;
                console.error = originalConsole.error;
                console.warn = originalConsole.warn;
                console.info = originalConsole.info;
                
                consoleCapturing = false;
                button.textContent = 'コンソール監視開始';
                button.className = button.className.replace('bg-red-500', 'bg-green-500').replace('hover:bg-red-600', 'hover:bg-green-600');
                
                log('📊 コンソール監視を停止しました', 'info');
            }
        }
        
        function appendConsoleLog(level, message, color) {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const div = document.createElement('div');
            div.style.color = color;
            div.textContent = `[${timestamp}] [${level}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearConsoleLog() {
            document.getElementById('consoleOutput').innerHTML = 'コンソール監視待機中...';
        }

        // ネットワーク監視機能
        function toggleNetworkCapture() {
            const button = document.getElementById('networkToggle');
            const output = document.getElementById('networkOutput');
            
            if (!networkCapturing) {
                // ネットワーク監視開始
                originalFetch = window.fetch;
                
                window.fetch = async function(...args) {
                    const startTime = Date.now();
                    const url = args[0];
                    const options = args[1] || {};
                    
                    appendNetworkLog(`🚀 ${options.method || 'GET'} ${url}`, '#3b82f6');
                    
                    try {
                        const response = await originalFetch.apply(this, args);
                        const duration = Date.now() - startTime;
                        const status = response.status;
                        const color = status >= 200 && status < 300 ? '#4ade80' : '#ef4444';
                        
                        appendNetworkLog(`${status >= 200 && status < 300 ? '✅' : '❌'} ${status} ${url} (${duration}ms)`, color);
                        
                        return response;
                    } catch (error) {
                        const duration = Date.now() - startTime;
                        appendNetworkLog(`💥 ERROR ${url} (${duration}ms): ${error.message}`, '#ef4444');
                        throw error;
                    }
                };
                
                networkCapturing = true;
                button.textContent = 'ネットワーク監視停止';
                button.className = button.className.replace('bg-blue-500', 'bg-red-500').replace('hover:bg-blue-600', 'hover:bg-red-600');
                output.innerHTML = '<div class="text-blue-500 text-sm">ネットワーク監視開始...</div>';
                
                log('🌐 ネットワーク監視を開始しました', 'info');
            } else {
                // ネットワーク監視停止
                if (originalFetch) {
                    window.fetch = originalFetch;
                }
                
                networkCapturing = false;
                button.textContent = 'ネットワーク監視開始';
                button.className = button.className.replace('bg-red-500', 'bg-blue-500').replace('hover:bg-red-600', 'hover:bg-blue-600');
                
                log('🌐 ネットワーク監視を停止しました', 'info');
            }
        }
        
        function appendNetworkLog(message, color) {
            const output = document.getElementById('networkOutput');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const div = document.createElement('div');
            div.className = 'text-sm py-1';
            div.style.color = color;
            div.textContent = `[${timestamp}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearNetworkLog() {
            document.getElementById('networkOutput').innerHTML = '<div class="text-gray-500 text-sm">ネットワーク監視待機中...</div>';
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async function() {
            log('🔧 統合デバッグツールを初期化中...', 'info');
            
            // 自動的にヘルスチェックを実行
            await testHealthCheck();
            
            // ApplicationAPIの状態を確認
            if (typeof ApplicationAPI !== 'undefined') {
                log('✅ ApplicationAPIが読み込まれました', 'success');
            } else {
                log('⚠️ ApplicationAPIが見つかりません', 'warning');
                log('💡 js/application-api.jsファイルが正しく読み込まれているか確認してください', 'info');
            }
            
            // エラーハンドリング
            window.addEventListener('error', function(event) {
                log(`🐛 JavaScriptエラー: ${event.message}`, 'error', {
                    filename: event.filename,
                    line: event.lineno,
                    column: event.colno,
                    error: event.error?.stack
                });
            });
            
            // Enter キーでリクエスト送信
            document.getElementById('endpoint').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendCustomRequest();
                }
            });
            
            log('✅ 統合デバッグツールの初期化完了', 'success');
        });
    </script>
</body>
</html>