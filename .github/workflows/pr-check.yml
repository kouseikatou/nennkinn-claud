name: PR Check & Staging Build

on:
  pull_request:
    # ä»»æ„ã®ãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã§å®Ÿè¡Œï¼ˆmain, develop, feature/*, ãªã©å…¨ã¦ï¼‰
  push:
    branches: [ feature/* ]                 # feature ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§ã®ã¿å®Ÿè¡Œ
  workflow_dispatch:                        # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# GitHub Pagesã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒç”¨ã®æ¨©é™
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install --no-package-lock || echo "No package.json found, skipping npm install"
    
    - name: Validate JavaScript syntax
      run: |
        echo "ğŸ” Validating JavaScript syntax..."
        has_error=false
        
        # Only check our project JavaScript files, exclude dependencies
        js_files=$(find . -name "*.js" \
          -not -path "./node_modules/*" \
          -not -path "./project-management-app/*/node_modules/*" \
          -not -path "./project-management-app/*/dist/*" \
          -not -path "./.git/*" \
          -not -name "gulpfile.*.js" \
          -not -name "webpack.*.js" \
          | grep -E '\.(js)$' | head -20)
        
        if [ -z "$js_files" ]; then
          echo "âš ï¸ No JavaScript files found to validate"
        else
          echo "Found JavaScript files to validate:"
          echo "$js_files"
          echo ""
          
          for file in $js_files; do
            echo "Checking $file"
            if ! node -c "$file"; then
              echo "âŒ Syntax error in $file"
              has_error=true
            else
              echo "âœ… $file is valid"
            fi
          done
        fi
        
        if [ "$has_error" = true ]; then
          echo "âŒ JavaScript validation failed"
          exit 1
        else
          echo "âœ… All JavaScript files are valid"
        fi
    
    - name: Check HTML files
      run: |
        echo "ğŸ” Checking HTML files..."
        html_files=$(find . -name "*.html" -type f | head -10)
        if [ -z "$html_files" ]; then
          echo "âš ï¸ No HTML files found"
        else
          echo "âœ… Found HTML files:"
          echo "$html_files"
        fi
    
    - name: Verify required files
      run: |
        echo "ğŸ” Verifying required files..."
        required_files=("index.html" "projects.html" "js/projects-list.js")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file is missing"
            exit 1
          fi
        done

  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  staging-build:
    runs-on: ubuntu-latest
    needs: code-quality
    environment:
      name: staging
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Build staging site
      run: |
        echo "ğŸš€ Building staging environment..."
        
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã®è¨­å®šã‚’è¿½åŠ 
        echo "<!-- STAGING ENVIRONMENT -->" >> index.html
        echo "<!-- Built from branch: ${{ github.head_ref || github.ref_name }} -->" >> index.html
        echo "<!-- Commit: ${{ github.sha }} -->" >> index.html
        
        # ãƒ“ãƒ«ãƒ‰ç¢ºèª
        echo "âœ… Staging build completed"
        echo "ğŸ“ Site contents:"
        ls -la
    
    - name: Test site functionality
      run: |
        echo "ğŸ§ª Testing site functionality..."
        
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ§‹é€ ãƒã‚§ãƒƒã‚¯
        if grep -q "<html" index.html && grep -q "</html>" index.html; then
          echo "âœ… index.html has valid HTML structure"
        else
          echo "âŒ index.html has invalid HTML structure"
          exit 1
        fi
        
        if grep -q "<html" projects.html && grep -q "</html>" projects.html; then
          echo "âœ… projects.html has valid HTML structure"
        else
          echo "âŒ projects.html has invalid HTML structure"
          exit 1
        fi
        
        # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ -f "js/projects-list.js" ]; then
          echo "âœ… Required JavaScript files present"
        else
          echo "âŒ Missing required JavaScript files"
          exit 1
        fi
        
        echo "âœ… All functionality tests passed"
    
    - name: Upload staging artifact
      uses: actions/upload-pages-artifact@v3
      with:
        name: staging-site
        path: .
    
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    # - name: Deploy to staging
    #   id: deployment
    #   uses: actions/deploy-pages@v4
    #   with:
    #     artifact_name: staging-site

  # æœ€çµ‚ç¢ºèª
  final-check:
    runs-on: ubuntu-latest
    needs: [code-quality, staging-build]
    steps:
    - name: PR Ready for Main
      run: |
        echo "ğŸ‰ All checks passed!"
        echo "âœ… Code quality check: PASSED"
        echo "âœ… Staging build: PASSED"
        echo "âœ… Site functionality: PASSED"
        echo ""
        echo "ğŸš€ This PR is ready to be merged to main branch"
        echo "ğŸ“ After merge, the changes will be automatically deployed to production"