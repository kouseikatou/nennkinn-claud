<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£çµãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">ğŸ”— ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£çµãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="test-results" class="space-y-4">
            <div class="text-gray-600">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„...</div>
        </div>
        
        <!-- èªè¨¼ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <h3 class="font-semibold text-yellow-800 mb-2">é–‹ç™ºç’°å¢ƒè¨­å®š</h3>
            <button onclick="DevAuth.skipAuth()" class="bg-yellow-500 text-white px-4 py-2 rounded mr-2">
                èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
            </button>
            <button onclick="DevAuth.enableAuth()" class="bg-gray-500 text-white px-4 py-2 rounded">
                èªè¨¼ã‚’æœ‰åŠ¹åŒ–
            </button>
            <div class="text-sm text-yellow-700 mt-2">
                èªè¨¼ã‚¹ã‚­ãƒƒãƒ—çŠ¶æ…‹: <span id="auth-status">ç¢ºèªä¸­...</span>
            </div>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ -->
        <div class="mt-6">
            <button onclick="runAllTests()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold">
                ğŸ§ª ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£çµãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            </button>
        </div>
    </div>

    <!-- APIé€£æºã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="js/application-api.js"></script>
    <script src="js/survey-integration.js"></script>
    
    <script>
        // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function addTestResult(testName, status, message) {
            const resultsDiv = document.getElementById('test-results');
            const statusIcon = status === 'success' ? 'âœ…' : status === 'warning' ? 'âš ï¸' : 'âŒ';
            const statusColor = status === 'success' ? 'text-green-600' : status === 'warning' ? 'text-yellow-600' : 'text-red-600';
            
            const testResult = document.createElement('div');
            testResult.className = 'border-l-4 pl-4 py-2 ' + (status === 'success' ? 'border-green-500' : status === 'warning' ? 'border-yellow-500' : 'border-red-500');
            testResult.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${statusIcon}</span>
                    <span class="font-semibold">${testName}</span>
                </div>
                <div class="${statusColor} text-sm mt-1">${message}</div>
            `;
            
            resultsDiv.appendChild(testResult);
        }

        // èªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°
        function updateAuthStatus() {
            const authStatus = document.getElementById('auth-status');
            if (DevAuth.isAuthSkipped()) {
                authStatus.textContent = 'ã‚¹ã‚­ãƒƒãƒ—ä¸­ (é–‹ç™ºãƒ¢ãƒ¼ãƒ‰)';
                authStatus.className = 'text-green-600 font-semibold';
            } else {
                authStatus.textContent = 'æœ‰åŠ¹';
                authStatus.className = 'text-gray-600';
            }
        }

        // å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        async function runAllTests() {
            // ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¯ãƒªã‚¢
            document.getElementById('test-results').innerHTML = '';
            
            addTestResult('ãƒ†ã‚¹ãƒˆé–‹å§‹', 'success', 'ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£çµãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');
            
            // 1. API Base URL ãƒ†ã‚¹ãƒˆ
            addTestResult('API Base URL è¨­å®š', 'success', `è¨­å®šå€¤: ${API_BASE_URL}`);
            
            // 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¥ç¶šãƒ†ã‚¹ãƒˆ
            try {
                const healthUrl = API_BASE_URL.replace('/api', '') + '/health';
                addTestResult('ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¥ç¶šãƒ†ã‚¹ãƒˆ', 'success', `æ¥ç¶šå…ˆ: ${healthUrl}`);
                
                const healthResponse = await fetch(healthUrl);
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    addTestResult('Health Check', 'success', `ã‚µãƒ¼ãƒãƒ¼æ­£å¸¸ç¨¼åƒä¸­ (ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ : ${Math.round(healthData.uptime)}ç§’)`);
                } else {
                    addTestResult('Health Check', 'error', `HTTP ${healthResponse.status}: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼`);
                    return;
                }
            } catch (error) {
                addTestResult('Health Check', 'error', `æ¥ç¶šå¤±æ•—: ${error.message}`);
                return;
            }
            
            // 3. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§ãƒ†ã‚¹ãƒˆ
            try {
                const apiListResponse = await fetch(API_BASE_URL.replace('/api', ''));
                if (apiListResponse.ok) {
                    const apiData = await apiListResponse.json();
                    addTestResult('API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ', 'success', `åˆ©ç”¨å¯èƒ½: ${Object.keys(apiData.endpoints).join(', ')}`);
                } else {
                    addTestResult('API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ', 'warning', 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—');
                }
            } catch (error) {
                addTestResult('API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ', 'warning', `ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            
            // 4. ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆç”°ä¸­å¤ªéƒã®ãƒ‡ãƒ¼ã‚¿ï¼‰
            try {
                const applications = await ApplicationAPI.getApplications();
                if (applications && applications.applications && applications.applications.length > 0) {
                    const tanakaApp = applications.applications.find(app => app.applicantName === 'ç”°ä¸­å¤ªéƒ');
                    if (tanakaApp) {
                        addTestResult('ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—', 'success', `ç”°ä¸­å¤ªéƒã®ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ (ID: ${tanakaApp.id})`);
                        
                        // 5. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ
                        await testSurveyData(tanakaApp.id);
                    } else {
                        addTestResult('ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—', 'warning', 'ç”°ä¸­å¤ªéƒã®ç”³è«‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                } else {
                    addTestResult('ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—', 'warning', 'ç”³è«‹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
            } catch (error) {
                addTestResult('ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—', 'error', `ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            
            addTestResult('ãƒ†ã‚¹ãƒˆå®Œäº†', 'success', 'ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }

        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ
        async function testSurveyData(applicationId) {
            const surveyTypes = ['basic', 'pre_application', 'injury'];
            
            for (const surveyType of surveyTypes) {
                try {
                    const surveyResult = await SurveyAPI.getSurvey(applicationId, surveyType);
                    if (surveyResult && surveyResult.survey) {
                        addTestResult(`ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå–å¾— (${surveyType})`, 'success', 
                            `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${surveyResult.survey.status}, ä½œæˆæ—¥: ${new Date(surveyResult.survey.createdAt).toLocaleString('ja-JP')}`);
                    } else {
                        addTestResult(`ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå–å¾— (${surveyType})`, 'warning', 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                } catch (error) {
                    addTestResult(`ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå–å¾— (${surveyType})`, 'warning', `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
            
            // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ†ã‚¹ãƒˆ
            try {
                const testData = {
                    personalInfo: {
                        name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                        email: 'test@example.com',
                        timestamp: new Date().toISOString()
                    }
                };
                
                const saveResult = await SurveyAPI.saveSurvey(applicationId, 'basic', testData, 'draft');
                if (saveResult) {
                    addTestResult('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¿å­˜ãƒ†ã‚¹ãƒˆ', 'success', 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸ');
                }
            } catch (error) {
                addTestResult('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¿å­˜ãƒ†ã‚¹ãƒˆ', 'error', `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthStatus();
            
            // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
            const originalSkipAuth = DevAuth.skipAuth;
            const originalEnableAuth = DevAuth.enableAuth;
            
            DevAuth.skipAuth = function() {
                originalSkipAuth.call(this);
                updateAuthStatus();
            };
            
            DevAuth.enableAuth = function() {
                originalEnableAuth.call(this);
                updateAuthStatus();
            };
        });
    </script>
</body>
</html>