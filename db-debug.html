<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ« - éšœå®³å¹´é‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            margin: 4px 0;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            word-break: break-all;
        }
        .log-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .log-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .log-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .log-debug { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        
        .json-viewer {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-checking { background-color: #ffc107; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
            <p class="text-gray-600">APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¾ã™</p>
        </div>

        <!-- æ¥ç¶šçŠ¶æ…‹ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span id="connectionStatus" class="status-indicator status-checking"></span>
                æ¥ç¶šçŠ¶æ…‹
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">APIã‚µãƒ¼ãƒãƒ¼</h3>
                    <p id="apiStatus" class="text-sm text-gray-600">ç¢ºèªä¸­...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h3>
                    <p id="dbStatus" class="text-sm text-gray-600">ç¢ºèªä¸­...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">èªè¨¼çŠ¶æ…‹</h3>
                    <p id="authStatus" class="text-sm text-gray-600">ç¢ºèªä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ« -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="testHealthCheck()" 
                        class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition-colors">
                    ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
                </button>
                <button onclick="testDatabaseConnection()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                    DBæ¥ç¶šãƒ†ã‚¹ãƒˆ
                </button>
                <button onclick="testApplicationsList()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded transition-colors">
                    ç”³è«‹ä¸€è¦§å–å¾—
                </button>
                <button onclick="testAuthentication()" 
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded transition-colors">
                    èªè¨¼ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
        </div>

        <!-- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨ºæ–­ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ” APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨ºæ–­</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ™ãƒ¼ã‚¹URL</label>
                <input type="text" id="baseUrl" value="https://nennkinn-claud.vercel.app/api" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</label>
                    <select id="endpoint" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="/health">GET /health</option>
                        <option value="/applications">GET /applications</option>
                        <option value="/applications/1">GET /applications/:id</option>
                        <option value="/auth/login">POST /auth/login</option>
                        <option value="/users">GET /users</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³</label>
                    <input type="text" id="authToken" placeholder="Bearer token"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <button onclick="testEndpoint()" 
                    class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-6 rounded transition-colors">
                ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
            </button>
        </div>

        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">ğŸ“‹ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
                <div class="space-x-2">
                    <button onclick="exportLogs()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                        ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="clearLogs()" 
                            class="bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                        ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
            <div id="logContainer" class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto">
                <div class="log-entry log-info">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ãŒèµ·å‹•ã—ã¾ã—ãŸ</div>
            </div>
        </div>
    </div>

    <!-- application-api.jsã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="js/application-api.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let logs = [];
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = {
                timestamp,
                message,
                type,
                data
            };
            logs.push(logEntry);
            
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            let content = `[${timestamp}] ${message}`;
            entry.textContent = content;
            
            if (data) {
                const dataView = document.createElement('div');
                dataView.className = 'json-viewer';
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                dataView.appendChild(pre);
                entry.appendChild(dataView);
            }
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry log-info">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div>';
        }

        // ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportLogs() {
            const logText = logs.map(log => 
                `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}${log.data ? '\n' + JSON.stringify(log.data, null, 2) : ''}`
            ).join('\n\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `db-debug-${new Date().toISOString()}.log`;
            a.click();
        }

        // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = `status-indicator status-${status}`;
        }

        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        async function testHealthCheck() {
            log('ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...', 'info');
            updateConnectionStatus('checking');
            
            try {
                const baseUrl = document.getElementById('baseUrl').value;
                const response = await fetch(`${baseUrl}/health`);
                const data = await response.text();
                
                let jsonData;
                try {
                    jsonData = JSON.parse(data);
                } catch {
                    jsonData = data;
                }
                
                if (response.ok) {
                    log('âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ', 'success', jsonData);
                    document.getElementById('apiStatus').textContent = 'æ­£å¸¸å‹•ä½œä¸­';
                    updateConnectionStatus('connected');
                } else {
                    log(`âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— (${response.status})`, 'error', jsonData);
                    document.getElementById('apiStatus').textContent = `ã‚¨ãƒ©ãƒ¼ (${response.status})`;
                    updateConnectionStatus('disconnected');
                }
            } catch (error) {
                log(`ğŸ’¥ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                document.getElementById('apiStatus').textContent = 'æ¥ç¶šå¤±æ•—';
                updateConnectionStatus('disconnected');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testDatabaseConnection() {
            log('ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info');
            
            try {
                // ApplicationAPIãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
                if (typeof ApplicationAPI !== 'undefined') {
                    const result = await ApplicationAPI.getApplications({ limit: 1 });
                    log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ', 'success', result);
                    document.getElementById('dbStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
                } else {
                    log('âš ï¸ ApplicationAPIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                    document.getElementById('dbStatus').textContent = 'APIæœªèª­ã¿è¾¼ã¿';
                }
            } catch (error) {
                log(`âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', error);
                document.getElementById('dbStatus').textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            }
        }

        // ç”³è«‹ä¸€è¦§ãƒ†ã‚¹ãƒˆ
        async function testApplicationsList() {
            log('ğŸ“‹ ç”³è«‹ä¸€è¦§ã‚’å–å¾—ä¸­...', 'info');
            
            try {
                const baseUrl = document.getElementById('baseUrl').value;
                const token = document.getElementById('authToken').value;
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
                }
                
                const response = await fetch(`${baseUrl}/applications?limit=5`, { headers });
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ… ç”³è«‹ä¸€è¦§å–å¾—æˆåŠŸ (${data.applications?.length || 0}ä»¶)`, 'success', data);
                } else {
                    log(`âŒ ç”³è«‹ä¸€è¦§å–å¾—å¤±æ•— (${response.status})`, 'error', data);
                }
            } catch (error) {
                log(`ğŸ’¥ ç”³è«‹ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // èªè¨¼ãƒ†ã‚¹ãƒˆ
        async function testAuthentication() {
            log('ğŸ” èªè¨¼ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info');
            
            try {
                const baseUrl = document.getElementById('baseUrl').value;
                const response = await fetch(`${baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@disability-pension.jp',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… èªè¨¼æˆåŠŸ', 'success', data);
                    document.getElementById('authStatus').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½';
                    if (data.token) {
                        document.getElementById('authToken').value = data.token;
                        log('ğŸ« ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•è¨­å®šã—ã¾ã—ãŸ', 'info');
                    }
                } else {
                    log(`âŒ èªè¨¼å¤±æ•— (${response.status})`, 'error', data);
                    document.getElementById('authStatus').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
                }
            } catch (error) {
                log(`ğŸ’¥ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                document.getElementById('authStatus').textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            }
        }

        // ä»»æ„ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
        async function testEndpoint() {
            const baseUrl = document.getElementById('baseUrl').value;
            const endpoint = document.getElementById('endpoint').value;
            const token = document.getElementById('authToken').value;
            
            log(`ğŸš€ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ: ${endpoint}`, 'info');
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
                }
                
                let options = { headers };
                
                if (endpoint === '/auth/login') {
                    options.method = 'POST';
                    options.body = JSON.stringify({
                        email: 'admin@disability-pension.jp',
                        password: 'admin123'
                    });
                }
                
                const response = await fetch(`${baseUrl}${endpoint}`, options);
                const data = await response.text();
                
                let jsonData;
                try {
                    jsonData = JSON.parse(data);
                } catch {
                    jsonData = data;
                }
                
                if (response.ok) {
                    log(`âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸ (${response.status})`, 'success', jsonData);
                } else {
                    log(`âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•— (${response.status})`, 'error', jsonData);
                }
            } catch (error) {
                log(`ğŸ’¥ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            log('ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ä¸­...', 'info');
            
            // è‡ªå‹•çš„ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            await testHealthCheck();
            
            // ApplicationAPIã®çŠ¶æ…‹ã‚’ç¢ºèª
            if (typeof ApplicationAPI !== 'undefined') {
                log('âœ… ApplicationAPIãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success');
                log('ğŸ“ APIè¨­å®š:', 'debug', {
                    baseURL: ApplicationAPI.getBaseURL ? ApplicationAPI.getBaseURL() : 'N/A'
                });
            } else {
                log('âš ï¸ ApplicationAPIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                log('ğŸ’¡ js/application-api.jsãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„', 'info');
            }
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’æ•æ‰
            window.addEventListener('error', function(event) {
                log(`ğŸ› JavaScriptã‚¨ãƒ©ãƒ¼: ${event.message}`, 'error', {
                    filename: event.filename,
                    line: event.lineno,
                    column: event.colno,
                    error: event.error?.stack
                });
            });
        });
    </script>
</body>
</html>